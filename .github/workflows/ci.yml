name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  scan_ruby:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Scan for common Rails security vulnerabilities using static analysis
        run: bin/brakeman --no-pager
      
      - name: Scan for known security vulnerabilities in gems used
        run: bin/bundler-audit
      
  scan_js:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Scan for security vulnerabilities in JavaScript dependencies
        run: bin/importmap audit

  lint:
    runs-on: ubuntu-latest
    env:
      RUBOCOP_CACHE_ROOT: tmp/rubocop
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare RuboCop cache
        uses: actions/cache@v5
        env:
          DEPENDENCIES_HASH: ${{ hashFiles('.ruby-version', '**/.rubocop.yml', '**/.rubocop_todo.yml', 'Gemfile.lock') }}
        with:
          path: ${{ env.RUBOCOP_CACHE_ROOT }}
          key: rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{ github.ref_name == github.event.repository.default_branch && github.run_id || 'default' }}
          restore-keys: |
            rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-

      - name: Lint code for consistent style
        run: bin/rubocop -f github

  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

      # redis:
      #   image: valkey/valkey:8
      #   ports:
      #     - 6379:6379
      #   options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Install packages
        run: sudo apt-get update && sudo apt-get install --no-install-recommends -y libpq-dev

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Install JavaScript dependencies
        run: npm ci

      - name: Precompile assets for tests
        env:
          RAILS_ENV: test
        run: bin/rails assets:precompile

      - name: Run tests
        env:
          RAILS_ENV: test
          DATABASE_URL: postgres://postgres:postgres@localhost:5432
          # RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
          # REDIS_URL: redis://localhost:6379/0
        run: npm run test:js && bin/rails db:test:prepare && bundle exec rspec

  # system-test:
  #   # Disabled: Project uses RSpec, not Minitest system tests
  #   # TODO: Re-enable when system tests are added (e.g., using Capybara with RSpec)
  #   runs-on: ubuntu-latest
  #
  #   services:
  #     postgres:
  #       image: postgres
  #       env:
  #         POSTGRES_USER: postgres
  #         POSTGRES_PASSWORD: postgres
  #       ports:
  #         - 5432:5432
  #       options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3
  #
  #     # redis:
  #     #   image: valkey/valkey:8
  #     #   ports:
  #     #     - 6379:6379
  #     #   options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
  #
  #   steps:
  #     - name: Install packages
  #       run: sudo apt-get update && sudo apt-get install --no-install-recommends -y libpq-dev
  #
  #     - name: Checkout code
  #       uses: actions/checkout@v5
  #
  #     - name: Set up Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         bundler-cache: true
  #
  #     - name: Run System Tests
  #       env:
  #         RAILS_ENV: test
  #         DATABASE_URL: postgres://postgres:postgres@localhost:5432
  #         # RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
  #         # REDIS_URL: redis://localhost:6379/0
  #       run: bin/rails db:test:prepare test:system
  #
  #     - name: Keep screenshots from failed system tests
  #       uses: actions/upload-artifact@v4
  #       if: failure()
  #       with:
  #         name: screenshots
  #         path: ${{ github.workspace }}/tmp/screenshots
  #         if-no-files-found: ignore

  deploy_staging:
    runs-on: ubuntu-latest
    needs:
      - scan_ruby
      - scan_js
      - lint
      - test
    # Keep pull_request enabled temporarily to validate deploy flow quickly.
    # Later, remove the pull_request branch from this condition and keep only push/main.
    if: |
      (env.STAGING_DEPLOY_ENABLED == 'true') &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.repo.full_name == github.repository))
    concurrency:
      group: staging-deploy
      cancel-in-progress: false
    environment: staging
    permissions:
      contents: read
    env:
      AWS_REGION: sa-east-1

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/balansi-staging-key.pem
          chmod 600 ~/.ssh/balansi-staging-key.pem
          ssh-keyscan -H 18.231.49.227 >> ~/.ssh/known_hosts

      - name: Build Kamal secrets file
        run: |
          KAMAL_REGISTRY_PASSWORD="$(aws ecr get-login-password --region "$AWS_REGION")"
          mkdir -p .kamal
          cat > .kamal/secrets <<EOF
          RAILS_MASTER_KEY=${{ secrets.STAGING_RAILS_MASTER_KEY }}
          KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD
          DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
          CACHE_DATABASE_URL=${{ secrets.STAGING_CACHE_DATABASE_URL }}
          QUEUE_DATABASE_URL=${{ secrets.STAGING_QUEUE_DATABASE_URL }}
          CABLE_DATABASE_URL=${{ secrets.STAGING_CABLE_DATABASE_URL }}
          EOF
          chmod 600 .kamal/secrets

      - name: Deploy to staging
        run: bin/kamal deploy -d staging
