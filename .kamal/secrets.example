# Kamal secrets template (safer mode)
# Copy to .kamal/secrets and keep this file local only.
# Secrets are fetched on demand from AWS instead of hardcoding plaintext.

# Requires: aws cli authenticated (prefer SSO/MFA) + jq installed.
# brew install jq

AWS_REGION=sa-east-1
RDS_SECRET_ARN=arn:aws:secretsmanager:sa-east-1:371952811921:secret:rds!db-REPLACE_ME
RAILS_MASTER_KEY_SECRET_ARN=arn:aws:secretsmanager:sa-east-1:371952811921:secret:/balansi/staging/rails/master_key-REPLACE_ME

# Keep host/port explicit (recommended) and fetch only username/password from secret.
DB_HOST=REPLACE_WITH_RDS_HOST
DB_PORT=5432
DB_USER=$(aws secretsmanager get-secret-value --region "$AWS_REGION" --secret-id "$RDS_SECRET_ARN" --query SecretString --output text | jq -r '.username')
DB_PASS=$(aws secretsmanager get-secret-value --region "$AWS_REGION" --secret-id "$RDS_SECRET_ARN" --query SecretString --output text | jq -r '.password')
DB_PASS_ENCODED=$(ruby -r uri -e 'print URI.encode_www_form_component(ARGV[0])' "$DB_PASS")

RAILS_MASTER_KEY=$(aws secretsmanager get-secret-value --region "$AWS_REGION" --secret-id "$RAILS_MASTER_KEY_SECRET_ARN" --query SecretString --output text)
KAMAL_REGISTRY_PASSWORD=$(aws ecr get-login-password --region "$AWS_REGION")

DATABASE_URL=postgresql://$DB_USER:$DB_PASS_ENCODED@$DB_HOST:$DB_PORT/balansi_staging
CACHE_DATABASE_URL=postgresql://$DB_USER:$DB_PASS_ENCODED@$DB_HOST:$DB_PORT/balansi_staging_cache
QUEUE_DATABASE_URL=postgresql://$DB_USER:$DB_PASS_ENCODED@$DB_HOST:$DB_PORT/balansi_staging_queue
CABLE_DATABASE_URL=postgresql://$DB_USER:$DB_PASS_ENCODED@$DB_HOST:$DB_PORT/balansi_staging_cable
